<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>ğŸ“Š ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ØªØ­ÙƒÙ… - WhatsApp Bot</title>
<style>
  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    margin: 0;
    padding: 0;
    background: #e0f0ff;
    color: #003366;
  }
  h1 {
    color: #ffffff;
    text-align: center;
    padding: 20px 0;
    background: linear-gradient(90deg, #004080, #0073e6);
    margin: 0;
    font-size: 28px;
    border-bottom: 2px solid #005bb5;
  }
  .container {
    display: flex;
    justify-content: center;
    align-items: flex-start;
    gap: 20px;
    width: 90%;
    max-width: 1200px;
    margin: 30px auto;
  }
  .center-box, .right-box {
    background: #cce0ff;
    padding: 25px;
    border-radius: 12px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
  }
  .center-box { flex: 2; }
  .right-box {
    flex: 1;
    max-height: 500px;
    overflow-y: auto;
  }
  h2 { 
    color: #004080; 
    margin-bottom: 15px; 
    font-size: 22px; 
  }
  select, textarea, button {
    padding: 12px;
    margin: 8px 0;
    width: 100%;
    font-size: 16px;
    border-radius: 6px;
    border: 1px solid #99c2ff;
    box-sizing: border-box;
    background: #f0f8ff;
    color: #003366;
  }
  textarea { resize: vertical; min-height: 120px; }
  button {
    background: #004080;
    color: #fff;
    border: none;
    cursor: pointer;
    font-weight: bold;
    transition: background 0.3s;
  }
  button:hover { background: #00264d; }
  
  /* Ù‚Ø§Ø¦Ù…Ø© Ø¢Ø®Ø± Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ - Ø³ØªØ§ÙŠÙ„ Ø¹ØµØ±ÙŠ */
  .list {
    background: #f0f8ff;
    padding: 15px;
    border-radius: 12px;
    border: 1px solid #99c2ff;
    color: #003366;
    max-height: 500px;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 12px;
  }
  .message {
    background: #ffffff;
    padding: 10px 15px;
    border-radius: 10px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    word-wrap: break-word;
  }
  .message b {
    color: #004080;
  }

  div#sendResult { margin-top: 10px; font-weight: bold; color: #004080; min-height: 24px; }
</style>
</head>
<body>

<h1>ğŸ“Š ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ØªØ­ÙƒÙ… - WhatsApp Bot</h1>

<div class="container">
  <!-- Ø§Ù„ÙˆØ³Ø·: Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© -->
  <div class="center-box">
    <h2>âœ‰ï¸ Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø©</h2>
    <label for="to">Ø§Ø®ØªØ§Ø± Ø§Ù„Ø±Ù‚Ù…:</label>
    <select id="to">
      <option value="">-- Ø§Ø®ØªØ± Ø±Ù‚Ù… --</option>
    </select>
    <textarea id="body" placeholder="Ù†Øµ Ø§Ù„Ø±Ø³Ø§Ù„Ø©"></textarea>
    <button onclick="sendMessage()">Ø¥Ø±Ø³Ø§Ù„</button>
    <div id="sendResult"></div>
  </div>

  <!-- Ø§Ù„ÙŠÙ…ÙŠÙ†: Ø¢Ø®Ø± 10 Ø±Ø³Ø§Ø¦Ù„ -->
  <div class="right-box">
    <h2>ğŸ•’ Ø¢Ø®Ø± 10 Ø±Ø³Ø§Ø¦Ù„</h2>
    <div id="lastMessages" class="list">Ø¬Ø§Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
    <button onclick="fetchMessages()">ğŸ”„ ØªØ­Ø¯ÙŠØ«</button>
  </div>
</div>

<script>
  if (window.location.protocol === "file:") {
    if (confirm("âš ï¸ Ø®Ø§ØµÙƒ ØªÙØªØ­ Ù‡Ø§Ø¯ Ø§Ù„ØµÙØ­Ø© Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±: http://localhost:5000/control\n\nØ¨ØºÙŠØª ØªÙ…Ø´ÙŠ Ø¯Ø§Ø¨Ø§ØŸ")) {
      window.location.href = "http://localhost:5000/control";
    } else {
      document.body.innerHTML = "<h2 style='color:red;text-align:center;margin-top:50px'>â›” ØªÙˆÙ‚Ù! Ø®Ø§ØµÙƒ ØªÙØªØ­ Ù‡Ø§Ø¯ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±.</h2>";
    }
  }

  async function fetchNumbers() {
    try {
      const res = await fetch('/numbers');
      const data = await res.json();
      const select = document.getElementById('to');
      select.innerHTML = '<option value="">-- Ø§Ø®ØªØ± Ø±Ù‚Ù… --</option>';
      if (data.length === 0) {
        const opt = document.createElement("option");
        opt.value = "";
        opt.textContent = "Ù…Ø§ ÙƒØ§ÙŠÙ†Ø´ Ø£Ø±Ù‚Ø§Ù… Ø­Ø§Ù„ÙŠØ§";
        select.appendChild(opt);
      } else {
        data.forEach(n => {
          const opt = document.createElement("option");
          opt.value = n;
          opt.textContent = n;
          select.appendChild(opt);
        });
      }
    } catch (err) { console.error(err); }
  }

  async function fetchMessages() {
    try {
      const res = await fetch('/last-messages');
      const data = await res.json();
      const container = document.getElementById('lastMessages');
      if(data.length === 0){
        container.innerHTML = "<div class='message'>Ù…Ø§ ÙƒØ§ÙŠÙ†Ø´ Ø±Ø³Ø§Ø¦Ù„ Ø­Ø§Ù„ÙŠØ§</div>";
      } else {
        container.innerHTML = data.map(m =>
          `<div class='message'><b>${m.phone}</b>: ${m.body}</div>`
        ).join('');
      }
    } catch(err) { console.error(err); }
  }

  async function sendMessage() {
    const to = document.getElementById('to').value;
    const body = document.getElementById('body').value;
    if (!to) { alert("â›” Ø®Ø§ØµÙƒ ØªØ®ØªØ§Ø± Ø§Ù„Ø±Ù‚Ù… Ø£ÙˆÙ„Ø§!"); return; }

    const sendResult = document.getElementById('sendResult');
    // Ù†Ù…Ø³Ø­ Ø£ÙŠ Ø­Ø§Ù„Ø© Ù‚Ø¯ÙŠÙ…Ø© Ù‚Ø¨Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©
    sendResult.innerText = "";

    try {
        const res = await fetch('/send-message', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ to, body })
        });

        const result = await res.json();

        if (result.status === "success") {
            sendResult.innerText = "âœ… Ø§Ù„Ø±Ø³Ø§Ù„Ø© ØªØ±Ø³Ù„Ø§Øª";
        } else {
            sendResult.innerText = "âŒ Ø®Ø·Ø£ ÙØ§Ù„Ø¥Ø±Ø³Ø§Ù„";
        }

        // Ù†Ù…Ø³Ø­ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ø¨Ø¹Ø¯ 3 Ø«ÙˆØ§Ù†ÙŠ
        setTimeout(() => {
            if (sendResult.innerText === "âœ… Ø§Ù„Ø±Ø³Ø§Ù„Ø© ØªØ±Ø³Ù„Ø§Øª" || sendResult.innerText === "âŒ Ø®Ø·Ø£ ÙØ§Ù„Ø¥Ø±Ø³Ø§Ù„") {
                sendResult.innerText = "";
            }
        }, 3000);

    } catch(err) {
        console.error(err);
        sendResult.innerText = "âŒ Ø®Ø·Ø£ ÙØ§Ù„Ø¥Ø±Ø³Ø§Ù„";
        setTimeout(() => { sendResult.innerText = ""; }, 3000);
    }
  }

  fetchNumbers();
  fetchMessages();
  // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø£ÙˆØªÙˆÙ…Ø§ØªÙŠÙƒÙŠØ§Ù‹ ÙƒÙ„ 10 Ø«ÙˆØ§Ù†ÙŠ
  setInterval(fetchMessages, 10000);
</script>

</body>
</html>
